<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TERRARIA : LIGHT & STEEL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #000; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: none; image-rendering: pixelated; width: 100vw; height: 100vh; }
        
        #menu { position: absolute; width: 100%; height: 100%; background: #111; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .box { background: #222; padding: 30px; border-radius: 15px; border: 2px solid #ffab40; text-align: center; width: 300px; }
        
        #ui { display: none; pointer-events: none; position: absolute; width: 100%; height: 100%; }
        #stats { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; border-left: 4px solid #ffab40; }
        #hp-bar { width: 150px; height: 10px; background: #333; margin: 5px 0; border-radius: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #ff4444; }
        
        #craft { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.9); padding: 12px; border-radius: 8px; pointer-events: auto; max-height: 85vh; overflow-y: auto; width: 200px; border: 1px solid #444; }
        .recipe-cat { font-size: 10px; color: #ffab40; font-weight: bold; margin-top: 8px; text-transform: uppercase; }
        .recipe { background: #333; padding: 5px; margin: 3px 0; border-radius: 3px; cursor: pointer; font-size: 10px; border: 1px solid #444; }
        .recipe:hover { border-color: #fff; }

        #hotbar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; pointer-events: auto; }
        .slot { width: 50px; height: 55px; background: rgba(0,0,0,0.8); border: 2px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 8px; }
        .slot.active { border-color: #ffab40; background: rgba(255,171,64,0.2); }
    </style>
</head>
<body>

    <div id="menu">
        <div class="box">
            <h1 style="color:#ffab40">FORGE & LUMIÈRE</h1>
            <input type="text" id="p-input" placeholder="Pseudo..." style="padding:10px; width:80%; margin-bottom:15px; background:#111; color:white; border:1px solid #444;">
            <button onclick="init()" style="padding:10px 20px; background:#ffab40; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">REJOINDRE</button>
        </div>
    </div>

    <div id="ui">
        <div id="stats">
            <b id="p-name">Joueur</b>
            <div id="hp-bar"><div id="hp-fill"></div></div>
            <div id="inv-txt" style="font-size:10px; color:#aaa;"></div>
        </div>
        <div id="craft">
            <div class="recipe-cat">Consommables</div>
            <div class="recipe" onclick="craftItem('torch')">Torche x4 (1 Bois)</div>
            <div class="recipe" onclick="craftItem('stick')">Bâton x4 (1 Bois)</div>
            <div id="armor-recipes"></div>
            <div id="tool-recipes"></div>
        </div>
        <div id="hotbar">
            <div class="slot active" id="s1" onclick="sel(1)">ÉPÉE</div>
            <div class="slot" id="s2" onclick="sel(2)">PIOCHE</div>
            <div class="slot" id="s3" onclick="sel(3)">TORCHE</div>
            <div class="slot" id="s4" onclick="sel(4)">ARC</div>
        </div>
    </div>

    <canvas id="cvs"></canvas>

<script>
const cvs = document.getElementById('cvs'), ctx = cvs.getContext('2d');
let world = [], torches = [], lastT = 0, activeS = 1, keys = {};
const TILE = 32, ROWS = 60, COLS = 100;

let p = { x: 1500, y: 800, w: 20, h: 36, vx: 0, vy: 0, hp: 100, def: 0, grounded: false };
let inv = { bois: 20, pierre: 10, fer: 0, palladium: 0, batons: 10, torches: 5, fleches: 10 };
let armor = { Casque:null, Plastron:null, Jambieres:null, Bottes:null };
let tools = { 
    1: {t:'Épée', m:'bois', p:10}, 
    2: {t:'Pioche', m:'bois', p:1},
    3: {t:'Torche', m:'stick', p:0}
};

const COLORS = { bois:"#795548", pierre:"#90a4ae", fer:"#cfd8dc", palladium:"#ff4d00", base:"#00d4ff" };

function init() {
    p.name = document.getElementById('p-input').value || "Héros";
    document.getElementById('menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    cvs.style.display = 'block';
    
    // Génération
    for(let y=0; y<ROWS; y++) {
        world[y] = [];
        for(let x=0; x<COLS; x++) {
            let id = (y > 30) ? 3 : (y === 30 ? 1 : 0);
            if(y > 35 && Math.random() < 0.08) id = 5;
            if(y > 55 && Math.random() < 0.15) id = 9;
            world[y][x] = id;
        }
    }
    buildCraftMenu();
    requestAnimationFrame(loop);
}

function buildCraftMenu() {
    const tList = document.getElementById('tool-recipes');
    const aList = document.getElementById('armor-recipes');
    const mats = ['pierre', 'fer', 'palladium'];
    
    tList.innerHTML = '<div class="recipe-cat">Outils</div>';
    mats.forEach(m => {
        ['Épée', 'Pioche'].forEach(type => {
            let d = document.createElement('div'); d.className = 'recipe';
            d.innerText = `${type} en ${m}`;
            d.onclick = () => craftTool(type, m);
            tList.appendChild(d);
        });
    });

    aList.innerHTML = '<div class="recipe-cat">Armures</div>';
    ['Casque', 'Plastron', 'Jambieres', 'Bottes'].forEach(pc => {
        mats.forEach(m => {
            let d = document.createElement('div'); d.className = 'recipe';
            d.innerText = `${pc} ${m}`;
            d.onclick = () => craftArmor(pc, m);
            aList.appendChild(d);
        });
    });
}

function craftItem(type) {
    if(type==='stick' && inv.bois >= 1) { inv.bois--; inv.batons += 4; }
    if(type==='torch' && inv.bois >= 1) { inv.bois--; inv.torches += 4; }
    updateUI();
}

function craftTool(type, m) {
    const cost = (type === 'Épée') ? 2 : 3;
    const power = { pierre: 2, fer: 5, palladium: 15 };
    if(inv[m] >= cost && inv.batons >= 2) {
        inv[m] -= cost; inv.batons -= 2;
        let slot = (type === 'Épée') ? 1 : 2;
        tools[slot] = { t:type, m:m, p:power[m] };
        updateUI();
    }
}

function craftArmor(pc, m) {
    const costs = { Bottes:4, Jambieres:5, Casque:5, Plastron:7 };
    const defs = { pierre:2, fer:8, palladium:20 };
    if(inv[m] >= costs[pc]) {
        inv[m] -= costs[pc];
        armor[pc] = { mat:m, def:defs[m] };
        p.def = Object.values(armor).reduce((s, a) => s + (a?a.def:0), 0);
        updateUI();
    }
}

function loop(t) {
    let dt = (t - lastT) / 1000; lastT = t;
    if(dt > 0.1) dt = 0.016;

    let mv = (keys.d?1:0) - (keys.q?1:0);
    p.vx = mv * 300; p.vy += 1500 * dt;
    p.x += p.vx * dt; p.y += p.vy * dt;

    let gx = Math.floor(p.x/TILE), gy = Math.floor((p.y+p.h)/TILE);
    if(world[gy]?.[gx] > 0) { p.y = gy*TILE - p.h; p.vy = 0; p.grounded = true; } else p.grounded = false;

    draw();
    requestAnimationFrame(loop);
}

function draw() {
    let cx = p.x - cvs.width/2, cy = p.y - cvs.height/2;
    
    // 1. Fond
    ctx.fillStyle = "#111"; ctx.fillRect(0,0,cvs.width,cvs.height);

    // 2. Monde
    for(let y=0; y<ROWS; y++) {
        for(let x=Math.floor(cx/TILE); x<Math.floor((cx+cvs.width)/TILE)+1; x++) {
            if(world[y]?.[x] > 0) {
                ctx.fillStyle = {1:"#2d5a27", 3:"#444", 5:"#ddd", 9:"#ff4d00"}[world[y][x]];
                ctx.fillRect(x*TILE-cx, y*TILE-cy, TILE, TILE);
            }
        }
    }

    // 3. Torches posées
    torches.forEach(tr => {
        ctx.fillStyle = "#ffab40";
        ctx.fillRect(tr.x*TILE-cx+12, tr.y*TILE-cy+10, 8, 16);
    });

    // 4. Joueur
    let px = p.x-cx, py = p.y-cy;
    ctx.fillStyle = COLORS[armor.Plastron?.mat || 'base'];
    ctx.fillRect(px, py, p.w, p.h);

    // 5. SYSTÈME DE LUMIÈRE (OMBRE PORTÉE)
    ctx.globalCompositeOperation = 'multiply';
    let lightGrad = ctx.createRadialGradient(px+10, py+10, 20, px+10, py+10, 150);
    lightGrad.addColorStop(0, "white");
    lightGrad.addColorStop(1, "black");
    
    // On remplit tout en noir sauf autour du joueur et des torches
    ctx.fillStyle = "black";
    ctx.globalAlpha = 0.8; // Niveau d'obscurité
    ctx.fillRect(0,0,cvs.width,cvs.height);
    
    ctx.globalCompositeOperation = 'destination-out';
    // Lumière du joueur
    ctx.beginPath(); ctx.arc(px+10, py+18, 120, 0, Math.PI*2); ctx.fill();
    // Lumière des torches
    torches.forEach(tr => {
        ctx.beginPath(); ctx.arc(tr.x*TILE-cx+16, tr.y*TILE-cy+16, 150, 0, Math.PI*2); ctx.fill();
    });
    
    ctx.globalCompositeOperation = 'source-over';
    ctx.globalAlpha = 1.0;
}

function updateUI() {
    document.getElementById('hp-fill').style.width = p.hp + "%";
    document.getElementById('inv-txt').innerText = `Bois:${inv.bois} | Fer:${inv.fer} | Palla:${inv.palladium} | Torches:${inv.torches}`;
    document.getElementById('s1').innerText = `ÉPÉE ${tools[1].m}`;
    document.getElementById('s2').innerText = `PIOCHE ${tools[2].m}`;
    document.getElementById('s3').innerText = `TORCHES (${inv.torches})`;
}

window.onkeydown = e => { keys[e.key.toLowerCase()] = true; if(e.key===' ' && p.grounded) p.vy = -520; };
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

cvs.onmousedown = e => {
    let cx = p.x-cvs.width/2, cy = p.y-cvs.height/2;
    let mx = e.clientX+cx, my = e.clientY+cy, gx = Math.floor(mx/TILE), gy = Math.floor(my/TILE);

    if(activeS === 2) { // Minage
        let id = world[gy]?.[gx];
        if(id === 5) inv.fer++; if(id === 9) inv.palladium++; if(id === 3) inv.pierre++;
        world[gy][gx] = 0;
    }
    if(activeS === 3 && inv.torches > 0) { // Poser Torche
        torches.push({x:gx, y:gy});
        inv.torches--;
    }
    updateUI();
};

function sel(n) { activeS = n; document.querySelectorAll('.slot').forEach((s,i)=>s.classList.toggle('active', i+1===n)); }
cvs.width = window.innerWidth; cvs.height = window.innerHeight;
</script>
</body>
</html>
