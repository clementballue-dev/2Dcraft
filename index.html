<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Glitch Friends RPG</title>
<style>
body { margin:0; background:black; color:white; font-family:monospace; }
canvas { display:block; margin:auto; background:black; }
#ui {
  position:absolute; bottom:10px; left:50%;
  transform:translateX(-50%);
  background:#000; border:2px solid #0f0;
  padding:8px; min-width:320px; text-align:center;
}
button { margin:4px; }
</style>
</head>
<body>

<canvas id="game" width="512" height="384"></canvas>
<div id="ui">DÃ©place-toi (flÃ¨ches) et appuie sur E</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const ui = document.getElementById("ui");

let mode = "map";
let camera = { x:0, y:0 };

// ---------------- MAP ----------------
const TILE = 32;
const map = [
 "1111111111111111",
 "1000000000000001",
 "1000011111100001",
 "1000010000100001",
 "1000010000100001",
 "1000000000000001",
 "1111111111111111"
];

// ---------------- JOUEUR ----------------
let player = { x:64, y:64, size:16, hp:100 };

// ---------------- EQUIPE ----------------
let team = [
  { name:"BunnyBit", hp:100, atk:12 },
  { name:"BearToy", hp:140, atk:8 },
  { name:"FoxByte", hp:80, atk:18 },
  { name:"CatLoop", hp:90, atk:6 }
];

// ---------------- PNJ ----------------
let npcs = [
  { x:160, y:96, text:"Tu es prÃªt Ã  combattre ?" },
  { x:320, y:160, text:"Attention aux bugs..." }
];

// ---------------- ENNEMI ----------------
let enemy = { name:"Bug Corrompu", hp:80, atk:8 };

// ---------------- SAUVEGARDE ----------------
function saveGame() {
  localStorage.setItem("save", JSON.stringify({
    player, team
  }));
}

function loadGame() {
  let data = localStorage.getItem("save");
  if (data) {
    let s = JSON.parse(data);
    player = s.player;
    team = s.team;
  }
}

// ---------------- CLAVIER ----------------
let keys = {};
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

// ---------------- BOUCLE ----------------
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (mode === "map") updateMap();
  if (mode === "battle") drawBattle();
  requestAnimationFrame(loop);
}

// ---------------- MAP ----------------
function updateMap() {
  movePlayer();

  camera.x = player.x - canvas.width/2;
  camera.y = player.y - canvas.height/2;

  drawMap();

  npcs.forEach(npc => {
    ctx.fillStyle = "pink";
    ctx.fillRect(npc.x - camera.x, npc.y - camera.y, 16, 16);

    if (keys["e"] && collision(player, npc)) {
      startDialog(npc.text);
    }
  });

  ctx.fillStyle = "cyan";
  ctx.fillRect(player.x - camera.x, player.y - camera.y, 16, 16);
}

function drawMap() {
  for (let y=0;y<map.length;y++) {
    for (let x=0;x<map[y].length;x++) {
      let tile = map[y][x];
      ctx.fillStyle = tile==="1" ? "#444" : "#2b8c3e";
      ctx.fillRect(x*TILE - camera.x, y*TILE - camera.y, TILE, TILE);
    }
  }
}

function movePlayer() {
  let speed = 2;
  let nx = player.x;
  let ny = player.y;

  if (keys["ArrowUp"]) ny -= speed;
  if (keys["ArrowDown"]) ny += speed;
  if (keys["ArrowLeft"]) nx -= speed;
  if (keys["ArrowRight"]) nx += speed;

  if (!wallAt(nx, ny)) {
    player.x = nx;
    player.y = ny;
    saveGame();
  }
}

function wallAt(x,y) {
  let tx = Math.floor(x / TILE);
  let ty = Math.floor(y / TILE);
  return map[ty] && map[ty][tx] === "1";
}

// ---------------- COLLISION ----------------
function collision(a,b) {
  return a.x < b.x+16 && a.x+16 > b.x &&
         a.y < b.y+16 && a.y+16 > b.y;
}

// ---------------- DIALOGUE ----------------
function startDialog(text) {
  mode = "dialog";
  ui.innerHTML = text + "<br><button onclick='startBattle()'>Combattre</button>";
}

// ---------------- COMBAT ----------------
function startBattle() {
  mode = "battle";
  enemy.hp = 80;
  ui.innerHTML = "ðŸ‘¾ " + enemy.name + " apparaÃ®t !<br>" + battleButtons();
}

function battleButtons() {
  return team.map((c,i)=>
    `<button onclick="attack(${i})">${c.name} (${c.hp})</button>`
  ).join("");
}

function drawBattle() {
  ctx.fillStyle = "#111";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  team.forEach((c,i)=>{
    ctx.fillStyle = "cyan";
    ctx.fillRect(60,80+i*40,24,24);
    ctx.fillText(c.name+" HP:"+c.hp, 100, 95+i*40);
  });

  ctx.fillStyle = "red";
  ctx.fillRect(360,150,32,32);
  ctx.fillText("HP Ennemi:"+enemy.hp, 320, 120);
}

function attack(i) {
  enemy.hp -= team[i].atk;
  if (enemy.hp <= 0) {
    ui.innerHTML = "ðŸŽ‰ Victoire !<br><button onclick='endBattle()'>Retour</button>";
    saveGame();
  } else {
    setTimeout(enemyAttack, 400);
  }
}

function enemyAttack() {
  let t = team[Math.floor(Math.random()*team.length)];
  t.hp -= enemy.atk;
  ui.innerHTML = "ðŸ‘¾ L'ennemi attaque !<br>" + battleButtons();
}

function endBattle() {
  mode = "map";
  ui.innerHTML = "DÃ©place-toi et parle aux PNJ";
  saveGame();
}

// ---------------- LANCEMENT ----------------
loadGame();
loop();
</script>

</body>
</html>
